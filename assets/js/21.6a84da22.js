(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{412:function(t,s,a){"use strict";a.r(s);var e=a(54),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"ленивая-загрузка-модулеи-lazy-loading-modules"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ленивая-загрузка-модулеи-lazy-loading-modules"}},[t._v("#")]),t._v(" Ленивая загрузка модулей (lazy-loading modules)")]),t._v(" "),a("p",[t._v("По умолчанию модули загружаются сразу, что означает, что как только приложение загружается, загружаются и все\nмодули, независимо от того, нужны ли они в данный момент. Хотя это нормально для большинства приложений, это может\nстать узким местом для приложений, работающих в "),a("strong",[t._v("бессерверной среде")]),t._v(', где задержка запуска ("холодный старт")\nимеет решающее значение.')]),t._v(" "),a("p",[t._v('Ленивая загрузка может помочь уменьшить время загрузки, загружая только модули, необходимые для конкретного вызова\nбессерверной функции. Кроме того, вы можете асинхронно загружать другие модули, как только бессерверная функция\n"разогрета", чтобы еще больше ускорит время загрузки для последующих вызовов (отложенная регистрация модулей).')]),t._v(" "),a("blockquote",[a("p",[t._v("Если вы знакомы с фреймворком "),a("strong",[t._v("Angular")]),t._v(', вы, возможно, уже встречали термин\n"лениво загружаемые модули (lazy-loading modules)". Имейте в виду, что эта техника '),a("strong",[t._v("функционально отличается")]),t._v(" в Nest, поэтому думайте\nоб этом как о совершенно другой функции, которая имеет схожие соглашения об именовании.")])]),t._v(" "),a("h2",{attrs:{id:"начало-работы"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#начало-работы"}},[t._v("#")]),t._v(" Начало работы")]),t._v(" "),a("p",[t._v("Для загрузки модулей по требованию Nest предоставляет класс "),a("code",[t._v("LazyModuleLoader")]),t._v(", который может быть инжектирован\nв класс обычным способом:")]),t._v(" "),a("div",{staticClass:"filename"},[t._v("cats.service.ts")]),t._v(" "),a("div",{staticClass:"language-typescript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-typescript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token decorator"}},[a("span",{pre:!0,attrs:{class:"token at operator"}},[t._v("@")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Injectable")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CatsService")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("constructor")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" lazyModuleLoader"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" LazyModuleLoader"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("blockquote",[a("p",[t._v("Класс "),a("code",[t._v("LazyModuleLoader")]),t._v(" импортируется из пакета "),a("code",[t._v("@nestjs/core")]),t._v(".")])]),t._v(" "),a("p",[t._v("В качестве альтернативы вы можете получить ссылку на провайдер "),a("code",[t._v("LazyModuleLoader")]),t._v(" из файла начальной загрузки\nвашего приложения ("),a("code",[t._v("main.ts")]),t._v(") следующим образом:")]),t._v(" "),a("div",{staticClass:"language-typescript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-typescript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// "app" - инстанст приложение Nest')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" lazyModuleLoader "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("LazyModuleLoader"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("Теперь вы можете загрузить любой модуль, используя следующую конструкцию:")]),t._v(" "),a("div",{staticClass:"language-typescript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-typescript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" LazyModule "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./lazy.module'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" moduleRef "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("lazyModuleLoader"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("load")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" LazyModule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("blockquote",[a("p",[t._v('"Лениво загруженные" модули '),a("strong",[t._v("кэшируются")]),t._v(" при первом вызове метода "),a("code",[t._v("LazyModuleLoader#load")]),t._v(". Это\nозначает, что каждая последующая попытка загрузить "),a("code",[t._v("LazyModule")]),t._v(" будет "),a("strong",[t._v("очень быстрой")]),t._v(" и будет возвращать кэшированный\nэкземпляр, вместо того, чтобы загружать модуль снова.")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("Load "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"LazyModule"')]),t._v(" attempt: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\ntime: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(".379ms\nLoad "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"LazyModule"')]),t._v(" attempt: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("\ntime: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(".294ms\nLoad "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"LazyModule"')]),t._v(" attempt: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("\ntime: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(".303ms\n")])])]),a("p",[t._v('Кроме того, "лениво загруженные" модули разделяют тот же граф модулей, что и те, которые загружаются при загрузке\nприложения, а также любые другие ленивые модули, зарегистрированные позже в вашем приложении.')])]),t._v(" "),a("p",[a("code",[t._v("lazy.module.ts")]),t._v(" - это файл TypeScript, экспортирующий "),a("strong",[t._v("обычный модуль Nest")]),t._v(" (никаких дополнительных\nизменений не требуется).")]),t._v(" "),a("p",[t._v("Метод "),a("code",[t._v("LazyModuleLoader#load")]),t._v(" возвращает "),a("a",{attrs:{href:"/guide/fundamentals/module-ref"}},[t._v("ссылку на модуль")]),t._v(" (из "),a("code",[t._v("LazyModule")]),t._v("),\nкоторая позволяет вам перемещаться по внутреннему списку провайдеров и получать ссылку на любой провайдер,\nиспользуя его инъекционный токен в качестве ключа поиска.")]),t._v(" "),a("p",[t._v("Например, допустим, у нас есть "),a("code",[t._v("LazyModule")]),t._v(" со следующим определением:")]),t._v(" "),a("div",{staticClass:"language-typescript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-typescript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token decorator"}},[a("span",{pre:!0,attrs:{class:"token at operator"}},[t._v("@")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Module")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  providers"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("LazyService"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  exports"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("LazyService"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("LazyModule")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("blockquote",[a("p",[t._v("Лениво загружаемые модули не могут быть зарегистрированы как "),a("strong",[t._v("глобальные модули")]),t._v(",\nтак как это просто не имеет смысла (поскольку они регистрируются лениво, по требованию, когда все статически\nзарегистрированные модули уже инстанцированы). Аналогично, зарегистрированные "),a("strong",[t._v("глобальные сервисы")]),t._v("\n(охранники/перехватчики/и т.д.) "),a("strong",[t._v("не будут работать")]),t._v(" должным образом.")])]),t._v(" "),a("p",[t._v("С помощью этого мы можем получить ссылку на провайдера "),a("code",[t._v("LazyService")]),t._v(" следующим образом:")]),t._v(" "),a("div",{staticClass:"language-typescript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-typescript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" LazyModule "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./lazy.module'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" moduleRef "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("lazyModuleLoader"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("load")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" LazyModule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" LazyService "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./lazy.service'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" lazyService "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" moduleRef"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("LazyService"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("blockquote",[a("p",[t._v("Если вы используете "),a("strong",[t._v("Webpack")]),t._v(", обязательно обновите файл "),a("code",[t._v("tsconfig.json")]),t._v(" - установите\n"),a("code",[t._v("compilerOptions.module")]),t._v(" в "),a("code",[t._v('"esnext"')]),t._v(" и добавьте свойство "),a("code",[t._v("compilerOptions.moduleResolution")]),t._v(" с "),a("code",[t._v('"node"')]),t._v("\nв качестве значения:")]),t._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"compilerOptions"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"module"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"esnext"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"moduleResolution"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"node"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    ...\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("Настроив эти параметры, вы сможете использовать функцию "),a("a",{attrs:{href:"https://webpack.js.org/guides/code-splitting/",target:"_blank",rel:"noopener noreferrer"}},[t._v("code splitting"),a("OutboundLink")],1),t._v(".")])]),t._v(" "),a("h2",{attrs:{id:"ленивая-загрузка-контроллеров-шлюзов-и-резолверов"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ленивая-загрузка-контроллеров-шлюзов-и-резолверов"}},[t._v("#")]),t._v(" Ленивая загрузка контроллеров, шлюзов и резолверов")]),t._v(" "),a("p",[t._v("Поскольку контроллеры (или резолверы в GraphQL-приложениях) в Nest представляют собой наборы маршрутов/путей\n(или запросов/мутаций), вы "),a("strong",[t._v("не можете лениво загружать их")]),t._v(" с помощью класса "),a("code",[t._v("LazyModuleLoader")]),t._v(".")]),t._v(" "),a("blockquote",[a("p",[t._v("Контроллеры, "),a("a",{attrs:{href:"/guide/graphql/resolvers"}},[t._v("resolvers")]),t._v(" и "),a("a",{attrs:{href:"/guide/websockets/gateways"}},[t._v("gateways")]),t._v(", зарегистрированные внутри лениво\nзагруженных модулей, будут вести себя не так, как ожидается. Аналогично, вы не можете регистрировать функции\nпромежуточного ПО (реализуя интерфейс "),a("code",[t._v("MiddlewareConsumer")]),t._v(") по требованию.")])]),t._v(" "),a("p",[t._v("Допустим, вы создаете REST API (HTTP-приложение) с драйвером Fastify под капотом (используя пакет "),a("code",[t._v("@nestjs/platform-fastify")]),t._v(").\nFastify не позволяет вам регистрировать маршруты после того, как приложение готово/успешно прослушивает сообщения.\nЭто означает, что даже если мы проанализируем связки маршрутов, зарегистрированные в контроллерах модуля, все лениво\nзагруженные маршруты не будут доступны, поскольку нет возможности зарегистрировать их во время выполнения.")]),t._v(" "),a("p",[t._v("Аналогично, некоторые транспортные стратегии, предоставляемые нами в составе пакета "),a("code",[t._v("@nestjs/microservices")]),t._v("\n(включая Kafka, gRPC или RabbitMQ), требуют подписки/прослушивания определенных тем/каналов до установления соединения.\nКак только ваше приложение начнет прослушивать сообщения, фреймворк не сможет подписаться/прослушать новые темы.")]),t._v(" "),a("p",[t._v("Наконец, пакет "),a("code",[t._v("@nestjs/graphql")]),t._v(' с включенным подходом "код прежде всего (schema on-the-fly)" автоматически генерирует схему GraphQL на лету\nна основе метаданных. Это означает, что все классы должны быть загружены заранее. В противном случае создать подходящую,\nкорректную схему будет невозможно.')]),t._v(" "),a("h2",{attrs:{id:"общие-случаи-использования"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#общие-случаи-использования"}},[t._v("#")]),t._v(" Общие случаи использования")]),t._v(" "),a("p",[t._v("Чаще всего модули с ленивой загрузкой можно встретить в ситуациях, когда ваш worker/cron job/lambda и serverless function/webhook\nдолжны запускать разные сервисы (разную логику) в зависимости от входных аргументов (путь маршрута/данные/параметры запроса и т.д.).\nС другой стороны, модули с ленивой загрузкой могут не иметь большого смысла для монолитных приложений, где время запуска скорее\nне имеет значения.")])])}),[],!1,null,null,null);s.default=n.exports}}]);