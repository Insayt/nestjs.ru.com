<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Динамические модули | NestJS</title>
    <meta name="generator" content="VuePress 1.9.1">
    <script>(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
   m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
   (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

   ym(87021734, "init", {
        clickmap:false,
        trackLinks:false,
        accurateTrackBounce:true
   });</script>
    <meta name="description" content="Dynamic modules Nest JS документация">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.3d05f6df.css" as="style"><link rel="preload" href="/assets/js/app.cb24ec9f.js" as="script"><link rel="preload" href="/assets/js/2.6ffe1b8d.js" as="script"><link rel="preload" href="/assets/js/17.d56eea7c.js" as="script"><link rel="preload" href="/assets/js/9.91b56dc7.js" as="script"><link rel="prefetch" href="/assets/js/10.0726f48d.js"><link rel="prefetch" href="/assets/js/11.ba640f3d.js"><link rel="prefetch" href="/assets/js/12.4379d3c3.js"><link rel="prefetch" href="/assets/js/13.0e564983.js"><link rel="prefetch" href="/assets/js/14.286130f6.js"><link rel="prefetch" href="/assets/js/15.f408c145.js"><link rel="prefetch" href="/assets/js/16.cb64b63b.js"><link rel="prefetch" href="/assets/js/18.bbe8ded2.js"><link rel="prefetch" href="/assets/js/19.8d9bd70a.js"><link rel="prefetch" href="/assets/js/20.51728526.js"><link rel="prefetch" href="/assets/js/21.34ffd24c.js"><link rel="prefetch" href="/assets/js/22.08940657.js"><link rel="prefetch" href="/assets/js/23.da7758e4.js"><link rel="prefetch" href="/assets/js/24.581acebe.js"><link rel="prefetch" href="/assets/js/25.d53838c3.js"><link rel="prefetch" href="/assets/js/26.ed6d7e92.js"><link rel="prefetch" href="/assets/js/3.76a04e4c.js"><link rel="prefetch" href="/assets/js/4.b6c6d50c.js"><link rel="prefetch" href="/assets/js/5.af6ee897.js"><link rel="prefetch" href="/assets/js/6.2ad59a3b.js"><link rel="prefetch" href="/assets/js/7.5a6a118a.js"><link rel="prefetch" href="/assets/js/8.0d621cf8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.3d05f6df.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.svg" alt="NestJS" class="logo"> <span class="site-name can-hide">NestJS</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/Insayt/nestjs.ru.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/Insayt/nestjs.ru.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/guide/introduction.html" class="sidebar-link">Введение</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Обзор</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/first-steps.html" class="sidebar-link">Первые шаги</a></li><li><a href="/guide/controllers.html" class="sidebar-link">Контроллеры</a></li><li><a href="/guide/providers.html" class="sidebar-link">Провайдеры</a></li><li><a href="/guide/modules.html" class="sidebar-link">Модули</a></li><li><a href="/guide/middleware.html" class="sidebar-link">Middleware</a></li><li><a href="/guide/exception-filters.html" class="sidebar-link">Фильтры исключений</a></li><li><a href="/guide/pipes.html" class="sidebar-link">Pipes</a></li><li><a href="/guide/guards.html" class="sidebar-link">Guards</a></li><li><a href="/guide/interceptors.html" class="sidebar-link">Interceptors</a></li><li><a href="/guide/custom-decorators.html" class="sidebar-link">Пользовательские декораторы</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Основы</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/fundamentals/custom-providers.html" class="sidebar-link">Пользовательские провайдеры</a></li><li><a href="/guide/fundamentals/async-providers.html" class="sidebar-link">Асинхронные провайдеры</a></li><li><a href="/guide/fundamentals/dynamic-modules.html" aria-current="page" class="active sidebar-link">Динамические модули</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/fundamentals/dynamic-modules.html#введение" class="sidebar-link">Введение</a></li><li class="sidebar-sub-header"><a href="/guide/fundamentals/dynamic-modules.html#пример-использования-динамического-модуля" class="sidebar-link">Пример использования динамического модуля</a></li><li class="sidebar-sub-header"><a href="/guide/fundamentals/dynamic-modules.html#пример-модуля-config" class="sidebar-link">Пример модуля Config</a></li><li class="sidebar-sub-header"><a href="/guide/fundamentals/dynamic-modules.html#конфигурация-модуля" class="sidebar-link">Конфигурация модуля</a></li><li class="sidebar-sub-header"><a href="/guide/fundamentals/dynamic-modules.html#пример" class="sidebar-link">Пример</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="динамические-модули"><a href="#динамические-модули" class="header-anchor">#</a> Динамические модули</h1> <p>Глава <a href="/guide/modules">Модули</a> охватывает основы модулей Nest и включает краткое введение в
<a href="/guide/modules.html#динамические-модули">динамические модули</a>. Эта глава раскрывает тему динамических модулей.
После ее завершения вы должны хорошо понимать, что это такое и как их использовать.</p> <h2 id="введение"><a href="#введение" class="header-anchor">#</a> Введение</h2> <p>Большинство примеров кода в разделе <strong>Обзор</strong> используют обычные, или статические, модули.
Модули определяют группы компонентов, таких как <a href="/guide/providers">провайдеры</a> и <a href="/guide/controllers">контроллеры</a>, которые подходят
друг другу как модульная часть общего приложения. Они обеспечивают контекст выполнения, или область действия, для этих
компонентов. Например, провайдеры, определенные в модуле, видны другим членам модуля без необходимости их экспорта.
Когда провайдер должен быть виден за пределами модуля, он сначала экспортируется из своего главного модуля, а затем
импортируется в потребляющий модуль.</p> <p>Давайте рассмотрим знакомый пример.</p> <p>Сначала мы определим <code>UsersModule</code> для предоставления и экспорта <code>UsersService</code>. <code>UsersModule</code> - это <strong>хост</strong>
модуль для <code>UsersService</code>.</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./users.service'</span><span class="token punctuation">;</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>UsersService<span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span>UsersService<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UsersModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>Далее мы определим <code>AuthModule</code>, который импортирует <code>UsersModule</code>, делая экспортированные провайдеры <code>UsersModule</code>
доступными внутри <code>AuthModule</code>:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./auth.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../users/users.module'</span><span class="token punctuation">;</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>UsersModule<span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>AuthService<span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span>AuthService<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>Эти конструкции позволяют нам внедрить <code>UsersService</code>, например, в <code>AuthService</code>, который размещен в <code>AuthModule</code>:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../users/users.service'</span><span class="token punctuation">;</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthService</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> usersService<span class="token operator">:</span> UsersService<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">/*
    Implementation that makes use of this.usersService
  */</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Мы будем называть это <strong>статическим</strong> связыванием модулей. Вся информация, необходимая Nest для соединения модулей,
уже объявлена в принимающем и потребляющем модулях. Давайте разберем, что происходит во время этого процесса. Nest
делает <code>UsersService</code> доступным внутри <code>AuthModule</code> путем:</p> <ol><li>Инстанцирует <code>UsersModule</code>, включая импорт других модулей, которые потребляет сам <code>UsersModule</code>,
и разрешение любых зависимостей (см. <a href="/guide/fundamentals/custom-providers">Пользовательские провайдеры</a>).</li> <li>Инстанцирует <code>AuthModule</code> и предоставляет экспортируемые провайдеры <code>UsersModule</code> компонентам <code>AuthModule</code>
(так же, как если бы они были объявлены в <code>AuthModule</code>).</li> <li>Инжектирует экземпляр <code>UsersService</code> в <code>AuthService</code>.</li></ol> <h2 id="пример-использования-динамического-модуля"><a href="#пример-использования-динамического-модуля" class="header-anchor">#</a> Пример использования динамического модуля</h2> <p>При статическом связывании модулей у потребляющего модуля нет возможности <strong>влиять</strong> на конфигурацию провайдеров
модуля &quot;хоста&quot;. Почему это важно? Рассмотрим случай, когда у нас есть модуль общего назначения, который должен
вести себя по-разному в различных случаях использования. Это аналогично концепции &quot;плагина&quot; во многих системах,
где общий модуль требует определенной конфигурации, прежде чем он может быть использован потребителем.</p> <p>Хороший пример с Nest - это <strong>конфигурационный модуль</strong>. Многие приложения находят полезным внешнее представление
деталей конфигурации с помощью модуля конфигурации. Это позволяет легко динамически изменять настройки приложения
в различных средах развертывания: например, база данных разработки для разработчиков, база данных для среды тестирования и т. д.
Делегируя управление параметрами конфигурации модулю конфигурации, исходный код приложения остается независимым
от параметров конфигурации.</p> <p>Проблема заключается в том, что сам модуль конфигурации, поскольку он является общим (подобно &quot;плагину&quot;), должен
быть настроен потребляющим модулем. Именно здесь в игру вступают <em>динамические модули</em>. Используя возможности динамических
модулей, мы можем сделать наш модуль конфигурации <strong>динамическим</strong>, чтобы потребляющий модуль мог использовать API
для управления настройкой модуля конфигурации в момент его импорта.</p> <p>Другими словами, динамические модули предоставляют API для импорта одного модуля в другой и настройки свойств и поведения
этого модуля при импорте, в отличие от использования статических привязок, которые мы рассматривали до сих пор.</p> <p class="demo">Hello this is &lt;demo-component&gt;123</p> <h2 id="пример-модуля-config"><a href="#пример-модуля-config" class="header-anchor">#</a> Пример модуля Config</h2> <p>В этом разделе мы будем использовать базовую версию кода примера из главы
<a href="/guide/techniques/configuration#service">configuration chapter</a>. Завершенная версия на момент окончания
этой главы доступна в виде рабочего <a href="https://github.com/nestjs/nest/tree/master/sample/25-dynamic-modules" target="_blank" rel="noopener noreferrer">примера здесь<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>Наша задача состоит в том, чтобы <code>ConfigModule</code> принимал объект <code>options</code> для его настройки. Вот функционал, который мы хотим
создать. Базовый пример жестко кодирует расположение файла <code>.env</code> в корневой папке проекта. Предположим, мы хотим
сделать это настраиваемым, чтобы вы могли управлять файлами <code>.env</code> в любой папке по вашему выбору. Например, представьте,
что вы хотите хранить различные файлы <code>.env</code> в папке под корнем проекта под названием <code>config</code> (т.е. в папке, родственной
папке <code>src</code>). Вы хотели бы иметь возможность выбирать разные папки при использовании <code>ConfigModule</code> в разных проектах.</p> <p>Динамические модули дают нам возможность передавать параметры в импортируемый модуль, чтобы мы могли изменять
его поведение. Давайте посмотрим, как это работает. Будет полезно, если мы начнем с конечной цели - как это может
выглядеть с точки зрения потребляющего модуля, а затем будем работать в обратном направлении. Во-первых, давайте
быстро рассмотрим пример <em>статического</em> импорта <code>ConfigModule</code> (т.е. подход, который не имеет возможности влиять
на поведение импортируемого модуля). Обратите пристальное внимание на массив <code>imports</code> в декораторе <code>@Module()</code>:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AppController <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app.controller'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AppService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ConfigModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./config/config.module'</span><span class="token punctuation">;</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>ConfigModule<span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token operator">:</span> <span class="token punctuation">[</span>AppController<span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>AppService<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>Давайте рассмотрим, как может выглядеть импорт <em>динамического модуля</em>, в котором мы передаем объект конфигурации.
Сравните разницу в массиве <code>imports</code> между этими двумя примерами:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AppController <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app.controller'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AppService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ConfigModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./config/config.module'</span><span class="token punctuation">;</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>ConfigModule<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">{</span> folder<span class="token operator">:</span> <span class="token string">'./config'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token operator">:</span> <span class="token punctuation">[</span>AppController<span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>AppService<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>Давайте посмотрим, что происходит в приведенном выше динамическом примере. Каковы движущиеся части?</p> <ol><li><code>ConfigModule</code> - это обычный класс, поэтому мы можем сделать вывод, что у него должен быть <strong>статический метод</strong>
под названием <code>register()</code>. Мы знаем, что он статический, потому что мы вызываем его на классе <code>ConfigModule</code>,
а не на <strong>экземпляре</strong> класса. Примечание: этот метод, который мы вскоре создадим, может иметь любое произвольное имя,
но по соглашению мы должны называть его либо <code>forRoot()</code>, либо <code>register()</code>.</li> <li>Метод <code>register()</code> определен нами, поэтому мы можем принимать любые входные аргументы. В данном случае мы будем
принимать простой объект <code>options</code> с подходящими свойствами, что является типичным случаем.</li> <li>Мы можем сделать вывод, что метод <code>register()</code> должен возвращать что-то вроде <code>модуля</code>, поскольку его возвращаемое
значение появляется в знакомом списке <code>imports</code>, который, как мы уже видели, включает список модулей.</li></ol> <p>На самом деле, метод <code>register()</code> вернет нам <code>DynamicModule</code>. Динамический модуль - это не что иное, как модуль,
созданный во время выполнения, с теми же свойствами, что и статический модуль, плюс одно дополнительное свойство
под названием <code>module</code>. Давайте быстро рассмотрим пример объявления статического модуля, обращая пристальное внимание
на параметры модуля, передаваемые в декоратор:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>DogsModule<span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token operator">:</span> <span class="token punctuation">[</span>CatsController<span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>CatsService<span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span>CatsService<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>Динамические модули должны возвращать объект с точно таким же интерфейсом, плюс одно дополнительное свойство <code>module</code>.
Свойство <code>module</code> служит именем модуля и должно быть таким же, как имя класса модуля, как показано в примере ниже.</p> <blockquote><p>Для динамического модуля все свойства объекта module options являются необязательными <strong>за исключением</strong> <code>module</code>.</p></blockquote> <p>А как насчет статического метода <code>register()</code>? Теперь мы видим, что его задача - вернуть объект, который имеет интерфейс
<code>DynamicModule</code>. Когда мы вызываем его, мы предоставляем модуль в список <code>imports</code>, подобно тому, как мы сделали
бы это в статическом случае, указав имя класса модуля. Другими словами, API динамического модуля просто возвращает модуль,
но вместо того, чтобы фиксировать свойства в декораторе <code>@Module</code>, мы задаем их программно.</p> <p>Осталось еще несколько деталей, которые помогут сделать картину полной:</p> <ol><li>Теперь мы можем утверждать, что свойство <code>@Module()</code> декоратора <code>imports</code> может принимать не только имя класса модуля
(например, <code>imports: [UsersModule]</code>), но и функцию <strong>возвращающую</strong> динамический модуль (например,
<code>imports: [ConfigModule.register(...)]</code>).</li> <li>Динамический модуль может сам импортировать другие модули. Мы не будем делать этого в данном примере, но если
динамический модуль зависит от провайдеров из других модулей, вы будете импортировать их с помощью необязательного
свойства <code>imports</code>. Опять же, это в точности аналогично тому, как вы объявляете метаданные для статического модуля
с помощью декоратора <code>@Module()</code>.</li></ol> <p>Вооруженные этим знанием, мы можем теперь посмотреть, как должно выглядеть наше динамическое объявление <code>ConfigModule</code>.
Давайте попробуем это сделать.</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> DynamicModule<span class="token punctuation">,</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ConfigService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./config.service'</span><span class="token punctuation">;</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ConfigModule</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> DynamicModule <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      module<span class="token operator">:</span> ConfigModule<span class="token punctuation">,</span>
      providers<span class="token operator">:</span> <span class="token punctuation">[</span>ConfigService<span class="token punctuation">]</span><span class="token punctuation">,</span>
      exports<span class="token operator">:</span> <span class="token punctuation">[</span>ConfigService<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Теперь должно быть понятно, как эти части связаны друг с другом. Вызов <code>ConfigModule.register(...)</code> возвращает объект
<code>DynamicModule</code> со свойствами, которые по сути те же самые, что до сих пор мы предоставляли в качестве метаданных
через декоратор <code>@Module()</code>.</p> <blockquote><p>Импортируйте <code>DynamicModule</code> из <code>@nestjs/common</code>.</p></blockquote> <p>Однако наш динамический модуль пока не очень интересен, поскольку мы не представили никакой возможности
<strong>конфигурировать</strong> его, как мы собирались сделать. Давайте займемся этим дальше.</p> <h2 id="конфигурация-модуля"><a href="#конфигурация-модуля" class="header-anchor">#</a> Конфигурация модуля</h2> <p>Очевидным решением для настройки поведения <code>ConfigModule</code> является передача ему объекта <code>options</code> в статическом методе
<code>register()</code>, как мы догадались выше. Давайте еще раз посмотрим на свойство <code>imports</code> нашего потребляющего модуля:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AppController <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app.controller'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AppService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ConfigModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./config/config.module'</span><span class="token punctuation">;</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>ConfigModule<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">{</span> folder<span class="token operator">:</span> <span class="token string">'./config'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token operator">:</span> <span class="token punctuation">[</span>AppController<span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>AppService<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>Этот вариант прекрасно справляется с передачей объекта <code>options</code> нашему динамическому модулю. Как мы затем используем этот
объект <code>options</code> в <code>ConfigModule</code>? Давайте рассмотрим это. Мы знаем, что наш <code>ConfigModule</code> - это, по сути,
хост для предоставления и экспорта инжектируемого сервиса - <code>ConfigService</code> - для использования другими провайдерами.
На самом деле именно нашему <code>ConfigService</code> необходимо читать объект <code>options</code> для настройки своего поведения. Давайте
пока предположим, что мы знаем, как каким-то образом получить <code>options</code> из метода <code>register()</code> в <code>ConfigService</code>. Исходя
из этого предположения, мы можем внести несколько изменений в сервис, чтобы настроить его поведение на основе свойств
объекта <code>options</code>. (<strong>Примечание</strong>: на данный момент, поскольку мы <em>не</em> определили, как его передавать, мы просто жестко
закодируем <code>options</code>. Мы исправим это через минуту).</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> dotenv <span class="token keyword">from</span> <span class="token string">'dotenv'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> fs <span class="token keyword">from</span> <span class="token string">'fs'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> EnvConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./interfaces'</span><span class="token punctuation">;</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ConfigService</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">readonly</span> envConfig<span class="token operator">:</span> EnvConfig<span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span> folder<span class="token operator">:</span> <span class="token string">'./config'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> filePath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">||</span> <span class="token string">'development'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.env</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> envFile <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../../'</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>folder<span class="token punctuation">,</span> filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>envConfig <span class="token operator">=</span> dotenv<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>envFile<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">get</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>envConfig<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Теперь наш <code>ConfigService</code> знает, как найти файл <code>.env</code> в папке, которую мы указали в <code>options</code>.</p> <p>Наша оставшаяся задача - каким-то образом внедрить объект <code>options</code> из шага <code>register()</code> в наш <code>ConfigService</code>.
И конечно же, для этого мы будем использовать <em>инъекцию зависимостей</em>. Это ключевой момент, поэтому убедитесь,
что вы его понимаете. Наш <code>ConfigModule</code> предоставляет <code>ConfigService</code>. <code>ConfigService</code> в свою очередь зависит
от объекта <code>options</code>, который предоставляется только во время выполнения. Поэтому во время выполнения нам нужно
сначала связать объект <code>options</code> с IoC-контейнером Nest, а затем заставить Nest внедрить его в наш <code>ConfigService</code>.
Помните из главы <strong>Custom providers</strong>, что провайдеры могут
[включать любое значение] (/guide/fundamentals/custom-providers.html#проваидеры-без-сервисов),
а не только сервисы, поэтому мы вполне можем использовать инъекцию зависимостей для работы с простым объектом <code>options</code>.</p> <p>Давайте сначала займемся привязкой объекта options к IoC-контейнеру. Мы сделаем это в нашем статическом методе <code>register()</code>.
Помните, что мы динамически конструируем модуль, а одним из свойств модуля является список провайдеров. Поэтому нам нужно
определить наш объект options как провайдер. Это сделает его инжектируемым в <code>ConfigService</code>, чем мы воспользуемся в следующем
шаге. В приведенном ниже коде обратите внимание на массив <code>providers</code>:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> DynamicModule<span class="token punctuation">,</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ConfigService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./config.service'</span><span class="token punctuation">;</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ConfigModule</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">register</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token operator">:</span> DynamicModule <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      module<span class="token operator">:</span> ConfigModule<span class="token punctuation">,</span>
      providers<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          provide<span class="token operator">:</span> <span class="token string">'CONFIG_OPTIONS'</span><span class="token punctuation">,</span>
          useValue<span class="token operator">:</span> options<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        ConfigService<span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      exports<span class="token operator">:</span> <span class="token punctuation">[</span>ConfigService<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Теперь мы можем завершить процесс инъекцией провайдера <code>'CONFIG_OPTIONS'</code> в <code>ConfigService</code>. Напомним, что когда мы определяем
провайдера с помощью неклассового токена, нам нужно использовать декоратор <code>@Inject()</code>
[как описано здесь] (/guide/fundamentals/custom-providers.html#проваидеры-не-основанные-на-классах).</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> dotenv <span class="token keyword">from</span> <span class="token string">'dotenv'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> fs <span class="token keyword">from</span> <span class="token string">'fs'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable<span class="token punctuation">,</span> Inject <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> EnvConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./interfaces'</span><span class="token punctuation">;</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ConfigService</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">readonly</span> envConfig<span class="token operator">:</span> EnvConfig<span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token string">'CONFIG_OPTIONS'</span><span class="token punctuation">)</span> <span class="token keyword">private</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> filePath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">||</span> <span class="token string">'development'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.env</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> envFile <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../../'</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>folder<span class="token punctuation">,</span> filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>envConfig <span class="token operator">=</span> dotenv<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>envFile<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">get</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>envConfig<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>И последнее замечание: для простоты мы использовали строковый маркер (<code>'CONFIG_OPTIONS'</code>), но лучше всего
определить его как константу (или <code>Symbol</code>) в отдельном файле и импортировать этот файл. Например:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">CONFIG_OPTIONS</span> <span class="token operator">=</span> <span class="token string">'CONFIG_OPTIONS'</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="пример"><a href="#пример" class="header-anchor">#</a> Пример</h2> <p>Полный пример кода из этой главы можно найти <a href="https://github.com/nestjs/nest/tree/master/sample/25-dynamic-modules" target="_blank" rel="noopener noreferrer">здесь<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/guide/fundamentals/async-providers.html" class="prev">
        Асинхронные провайдеры
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.cb24ec9f.js" defer></script><script src="/assets/js/2.6ffe1b8d.js" defer></script><script src="/assets/js/17.d56eea7c.js" defer></script><script src="/assets/js/9.91b56dc7.js" defer></script>
  </body>
</html>
